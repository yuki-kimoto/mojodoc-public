<!DOCTYPE html>
<html>
  <head>
    <!-- meta -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<link rel="icon" type="image/x-icon" href="/images/logo.png">
<link rel="stylesheet" type="text/css" href="/css/common.css">

<script type="text/javascript" src="/js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="/js/google-code-prettify/prettify.js"></script>
<link  type="text/css" rel="stylesheet" href="/js/google-code-prettify/prettify.css"/>

<script>
  $(function(){
    // google code prettifyの有効化
    $("pre").addClass("prettyprint");
    function init(event){
      prettyPrint();
    }
    if(window.addEventListener)window.addEventListener("load",init,false);
    else if(window.attachEvent)window.attachEvent("onload",init);
  });
</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CP8HZ9DC1K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CP8HZ9DC1K');
</script>
<title>Mojo::UserAgent - ノンブロッキングI/OのHTTPとWebSocketのユーザーエージェント - Mojoliciousドキュメント 日本語訳</title>
<meta name="description" content="Mojo::UserAgent は完全な特徴を備えたノンブロッキングI/OのHTTPと WebSocketのユーザーエージェントです。 IPv6, TLS, SNI, IDNA, HTTP/SOCKS5プロキシ、Unixドメインソケット Comet (ロングポーリング), キープアライブ, コネクションポーリング, タイムアウト, クッキー、マルチパート、プロシキ、gzip圧縮、複数のイベントループをサポートしています。">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header_main">
  <h1>
    <a href="/"><img src="/images/logo.png">Mojoliciousドキュメント日本語訳</a>
  </h1>
  <div class="header_right">
    <a rel="nofollow" href="https://perlclub.net/account/create">会員登録</a>
  </div>
</div>

      </div>
      <div class="main">
        <div class="content">
          <div class="entry">
  <div class="top">
    
  </div>
  <div class="middle">
    <!-- 

<p><a href="/Mojo::UserAgent.html">Mojo::UserAgent</a> は完全な特徴を備えたノンブロッキングI/OのHTTPと WebSocketのユーザーエージェントです。 IPv6, TLS, SNI, IDNA, HTTP/SOCKS5プロキシ、Unixドメインソケット Comet (ロングポーリング), キープアライブ, コネクションポーリング, タイムアウト, クッキー、マルチパート、プロシキ、gzip圧縮、複数のイベントループをサポートしています。</p> -->
<html><head><title>名前</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.40,
  using Pod::Simple::PullParser v3.40,
  under Perl v5.032001 at Sat Oct  2 01:17:50 2021 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<a name='___top' class='dummyTopAnchor' ></a>

<div><a href="/mojo-api-reference.html">Mojolicious API リファレンス</a></div>

<h2><a href="/Mojo::UserAgent.html">Mojo::UserAgent - ノンブロッキングI/OのHTTPとWebSocketのユーザーエージェント</a></h2>
<div style="width:calc(100% - 30px);margin:10px auto;">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4525414114581084"
       crossorigin="anonymous"></script>
  <!-- 最初の段落下 - ディスプレイ 横長 レスポンシブ -->
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-4525414114581084"
       data-ad-slot="2828858335"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>



<h3><a class='u'
name="_"
>使い方</a></h3>

<pre>use Mojo::UserAgent;

# 良い粒度のレスポンスの処理(接続エラーの場合は、例外を発生)
my $ua  = Mojo::UserAgent-&gt;new;
my $res = $ua-&gt;get('mojolicious.org/perldoc')-&gt;result;
if    ($res-&gt;is_success)  { say $res-&gt;body }
elsif ($res-&gt;is_error)    { say $res-&gt;message }
elsif ($res-&gt;code == 301) { say $res-&gt;headers-&gt;location }
else                      { say 'Whatever...' }

# Acceptヘッダをつけてユニコードのスノーマンにハローを言う
say $ua-&gt;get('www.☃.net?hello=there' =&gt; {Accept =&gt; '*/*'})-&gt;result-&gt;body;

# HTMLとXMLのリソースからCSSセレクタを使ってデータを抽出する
say $ua-&gt;get('www.perl.org')-&gt;result-&gt;dom-&gt;at('title')-&gt;text;

# 新しいサイトから最近のヘッドラインをスクレイピングする
say $ua-&gt;get('blogs.perl.org')
  -&gt;result-&gt;dom-&gt;find('h2 &gt; a')-&gt;map('text')-&gt;join("\n");

# コンテンツのついたIPv6のPUTリクエスト
my $tx = $ua-&gt;put('[::1]:3000' =&gt; {'Content-Type' =&gt; 'text/plain'} =&gt; 'Hi!');

# ベーシック認証によるすばやいJSON APIリクエスト
my $value = $ua-&gt;get('https://sri:t3st@example.com/test.json')-&gt;result-&gt;json;

# TLS証明書認証のついたJSON POST (application/json)
my $tx = $ua-&gt;cert('tls.crt')-&gt;key('tls.key')
  -&gt;post('https://example.com' =&gt; json =&gt; {top =&gt; 'secret'});

# POSTフォーム (application/x-www-form-urlencoded)
my $tx = $ua-&gt;post('https://metacpan.org/search' =&gt; form =&gt; {q =&gt; 'mojo'});

# DuckDuckGoのanonymously through Torを検索
$ua-&gt;proxy-&gt;http('socks://127.0.0.1:9050');
say $ua-&gt;get('api.3g2upl4pq6kufc4m.onion/?q=mojolicious&format=json')
  -&gt;result-&gt;json('/Abstract');

# UNIXドメインソケットを通したGETリクエスト"/tmp/myapp.sock" (スラッシュをパーセントエンコード)
say $ua-&gt;get('http+unix://%2Ftmp%2Fmyapp.sock/perldoc')-&gt;result-&gt;body;

# GitHubからMojoliciousをダウンロードするためにリダイレクトを設定
$ua-&gt;max_redirects(5)
  -&gt;get('https://www.github.com/mojolicious/mojo/tarball/master')
  -&gt;result-&gt;save_to('/home/sri/mojo.tar.gz');

# ノンブロッキングリクエスト
$ua-&gt;get('mojolicious.org' =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;dom-&gt;at('title')-&gt;text;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;

# ノンブロッキングな並列リクエスト(プロミスで同期)
my $mojo = $ua-&gt;get_p('mojolicious.org');
my $cpan = $ua-&gt;get_p('cpan.org');
Mojo::Promise-&gt;all($mojo, $cpan)-&gt;then(sub {
  my ($mojo, $cpan) = @_;
  say $mojo-&gt;[0]-&gt;result-&gt;dom-&gt;at('title')-&gt;text;
  say $cpan-&gt;[0]-&gt;result-&gt;dom-&gt;at('title')-&gt;text;
})-&gt;wait;

# UNIXドメインソケットを通してJSONメッセージを受信・送信するためのノンブロッキングなWebSocket接続
$ua-&gt;websocket('ws+unix://%2Ftmp%2Fmyapp.sock/echo.json' =&gt; sub {
  my ($ua, $tx) = @_;
  say 'WebSocket handshake failed!' and return unless $tx-&gt;is_websocket;
  $tx-&gt;on(json =&gt; sub {
    my ($tx, $hash) = @_;
    say "WebSocket message via JSON: $hash-&gt;{msg}";
    $tx-&gt;finish;
  });
  $tx-&gt;send({json =&gt; {msg =&gt; 'Hello World!'}});
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h3><a class='u'
name="_"
>説明</a></h3>

<p><a href="/Mojo::UserAgent.html">Mojo::UserAgent</a> は完全な特徴を備えたノンブロッキングI/OのHTTPと WebSocketのユーザーエージェントです。 IPv6, TLS, SNI, IDNA, HTTP/SOCKS5プロキシ、Unixドメインソケット Comet (ロングポーリング), キープアライブ, コネクションポーリング, タイムアウト, クッキー、マルチパート、プロシキ、gzip圧縮、複数のイベントループをサポートしています。</p>

<p>すべての接続は、新しいプロセスがフォークされれば、自動的にリセットされます。 これは複数のプロセスが、同じ<a href="/Mojo::UserAgent.html">Mojo::UserAgent</a>オブジェクトを安全に共有する ことを許可します。</p>

<p>よりよいスケーラビリティ(epoll, kqueue)、ノンブロッキングの名前解決、 SOCK5、TLSサポートも以下のモジュールによってサポートされます。 オプションのモジュールとして<a href="https://metacpan.org/pod/EV" class="podlinkpod"
>EV</a>(4.0+), <a href="https://metacpan.org/pod/Net%3A%3ADNS%3A%3ANative" class="podlinkpod"
>Net::DNS::Native</a> (0.15+) <a href="https://metacpan.org/pod/IO%3A%3ASocket%3A%3ASSL" class="podlinkpod"
>IO::Socket::SSL</a>(2.009+),<a href="https://metacpan.org/pod/IO%3A%3ASocket%3A%3ASocks" class="podlinkpod"
>IO::Socket::Socks</a> (0.64+)、<a href="https://metacpan.org/pod/IO%3A%3ASocket%3A%3ASSL" class="podlinkpod"
>IO::Socket::SSL</a> (1.94+)が 透過的にサポートされ、インストールされていれば利用されます。 個々の機能は<code>MOJO_NO_NDN</code>、<code>MOJO_NO_IPV6</code>と<code>MOJO_NO_TLS</code>環境変数で無効にすることもできます。</p>

<h4><a class='u'
name="_"
>イベント</a></h4>

<p><a href="/Mojo::UserAgent.html">Mojo::UserAgent</a>は<a href="/Mojo::EventEmitter.html">Mojo::EventEmitter</a>を継承しており、次のイベントが発生します。</p>

<h4><a class='u'
name="prepare"
>prepare</a></h4>

<pre>$ua-&gt;on(prepare =&gt; sub {
  my ($ua, $tx) = @_;
  ...
});</pre>

<p>新しいトランザクションが準備されているときはいつでも、相対URLが書き換えられ、クッキーが追加される前に発行されます。 これは自動的に準備されたプロキシの<code>CONNECT</code>リクエストとそれに続くリダイレクトを含みます</p>

<pre>$ua-&gt;on(prepare =&gt; sub {
  my ($ua, $tx) = @_;
  $tx-&gt;req-&gt;url(Mojo::URL-&gt;new('/mock-mojolicious'))
    if $tx-&gt;req-&gt;url-&gt;host eq 'mojolicious.org';
});</pre>

<h4><a class='u'
name="start"
>start</a></h4>

<pre>$ua-&gt;on(start =&gt; sub {
  my ($ua, $tx) = @_;
  ...
});</pre>

<p>新しいトランザクションがまさに開始しようとしているときにいつでも発生します。 これは自動的に準備されるプロキシの<code>CONNECT</code>リクエストとレスポンス、それに続くリダイレクトも含みます。</p>

<pre>$ua-&gt;on(start =&gt; sub {
  my ($ua, $tx) = @_;
  $tx-&gt;req-&gt;headers-&gt;header('X-Bender', 'Bite my shiny metal ass!');
});</pre>

<h3><a class='u'
name="_"
>属性</a></h3>

<p><a href="/Mojo::UserAgent.html">Mojo::UserAgent</a> は以下の属性を実装しています。</p>

<h4><a class='u'
name="ca"
>ca</a></h4>

<pre>my $ca = $ua-&gt;ca;
$ua    = $ua-&gt;ca('/etc/tls/ca.crt');</pre>

<p>TLS認証局ファイルへのパス。 デフォルトは<code>MOJO_CA_FILE</code>環境変数の値。 ホスト名の検証も有効にします。</p>

<pre># デバッグで認証局を表示する
IO::Socket::SSL::set_ctx_defaults(
  SSL_verify_callback =&gt; sub { say "Authority: $_[2]" and return $_[0] });</pre>

<h4><a class='u'
name="cert"
>cert</a></h4>

<pre>my $cert = $ua-&gt;cert;
$ua      = $ua-&gt;cert('tls.crt');</pre>

<p>TLS証明書ファイルへのパス。デフォルトは <code>MOJO_CERT_FILE</code> の値です。</p>

<h4><a class='u'
name="connect_timeout"
>connect_timeout</a></h4>

<pre>my $timeout = $ua-&gt;connect_timeout;
$ua         = $ua-&gt;connect_timeout(5);</pre>

<p>接続が確立されるまでの最大秒数。デフォルトは<code>MOJO_CONNECT_TIMEOUT</code>環境変数 の値か<code>10</code>です。</p>

<h4><a class='u'
name="cookie_jar"
>cookie_jar</a></h4>

<pre>my $cookie_jar = $ua-&gt;cookie_jar;
$ua            = $ua-&gt;cookie_jar(Mojo::CookieJar-&gt;new);</pre>

<p>このユーザーエージェントのリクエストのためのクッキージャー。 デフォルトは <a href="/Mojo::CookieJar.html">Mojo::CookieJar</a> オブジェクトです。</p>

<pre># すべてのクッキーを無効にする
$ua-&gt;cookie_jar-&gt;ignore(sub { 1 });

# パブリックなサフィックスのためにクッキーを無視する
my $ps = IO::Socket::SSL::PublicSuffix-&gt;default;
$ua-&gt;cookie_jar-&gt;ignore(sub {
  my $cookie = shift;
  return undef unless my $domain = $cookie-&gt;domain;
  return ($ps-&gt;public_suffix($domain))[0] eq '';
});

# ジャーにカスタムクッキーを追加する
$ua-&gt;cookie_jar-&gt;add(
  Mojo::Cookie::Response-&gt;new(
    name   =&gt; 'foo',
    value  =&gt; 'bar',
    domain =&gt; 'mojolicio.us',
    path   =&gt; '/perldoc'
  )
);</pre>

<h4><a class='u'
name="inactivity_timeout"
>inactivity_timeout</a></h4>

<pre>my $timeout = $ua-&gt;inactivity_timeout;
$ua         = $ua-&gt;inactivity_timeout(15);</pre>

<p>接続がドロップする前に非アクティブでいる最大の秒数。 デフォルトは<code>MOJO_INACTIVITY_TIMEOUT</code>環境変数の値か<code>20</code>です。 この値を<code>0</code>に設定すると接続を永久に非アクティブにしたままにすることができます。</p>

<h4><a class='u'
name="insecure"
>insecure</a></h4>

<pre>my $bool = $ua-&gt;insecure;
$ua      = $ua-&gt;insecure($bool);</pre>

<p>Do not require a valid TLS certificate to access HTTPS/WSS sites, defaults to the value of the <code>MOJO_INSECURE</code> environment variable.</p>

<p>HTTPS / WSSサイトにアクセスするために有効なTLS証明書を必要としません。デフォルトは <code>MOJO_INSECURE</code>環境変数の値です。</p>

<pre># テスト用にTLS証明書の検証を無効にする
say $ua-&gt;insecure(1)-&gt;get('https://127.0.0.1:3000')-&gt;result-&gt;code;</pre>

<h4><a class='u'
name="ioloop"
>ioloop</a></h4>

<pre>my $loop = $ua-&gt;ioloop;
$ua      = $ua-&gt;ioloop(Mojo::IOLoop-&gt;new);</pre>

<p>I/O 処理のために利用されるループオブジェクト。デフォルトは <a href="/Mojo::IOLoop.html">Mojo::IOLoop</a> オブジェクトが利用されます。</p>

<h4><a class='u'
name="key"
>key</a></h4>

<pre>my $key = $ua-&gt;key;
$ua     = $ua-&gt;key('/etc/tls/client.crt');</pre>

<p>TLS キーファイルへのパス。デフォルトは <code>MOJO_KEY_FILE</code>環境変数の値です。</p>

<h4><a class='u'
name="local_address"
>local_address</a></h4>

<pre>my $address = $ua-&gt;local_address;
$ua         = $ua-&gt;local_address('127.0.0.1');</pre>

<p>バインドされているローカルアドレス。</p>

<h4><a class='u'
name="max_connections"
>max_connections</a></h4>

<pre>my $max_connections = $ua-&gt;max_connections;
$ua                 = $ua-&gt;max_connections(5);</pre>

<p>ユーザーエージェントが、最も古いキャッシュされた接続を閉じ始めるまでに 保有するキープアライブ接続の最大数。デフォルトは <code>5</code>。この値を<code>0</code>に設定するとすべての接続がケプトアライブになることを防ぎます。</p>

<h4><a class='u'
name="max_redirects"
>max_redirects</a></h4>

<pre>my $max_redirects = $ua-&gt;max_redirects;
$ua               = $ua-&gt;max_redirects(3);</pre>

<p>ユーザーエージェントが、失敗する前までに辿るリダイレクトの最大数。 デフォルトは <code>MOJO_MAX_REDIRECTS</code> の値、または <code>0</code> です。</p>

<h4><a class='u'
name="max_response_size"
>max_response_size</a></h4>

<pre>my $max = $ua-&gt;max_response_size;
$ua     = $ua-&gt;max_response_size(16777216);</pre>

<p>最大応答サイズ（バイト）。デフォルトは<a href="/Mojo::Message::Response.html">Mojo::Message::Response</a>の"max_message_size"の値です。 この値を<code>0</code>に設定すると、無限のサイズのレスポンスを許可します。 この値を増加させると、劇的にメモリの使用量が増えることに注意してください。たとえば、とても大きなサイズのレスポンスボディを、<a href="/Mojo::Message.html">Mojo::Message</a>の"dom"や"json"で解析しようとした場合などです。</p>

<h4><a class='u'
name="proxy"
>proxy</a></h4>

<pre>my $proxy = $ua-&gt;proxy;
$ua       = $ua-&gt;proxy(Mojo::UserAgent::Proxy-&gt;new);</pre>

<p>プロキシマネージャー。デフォルトは<a href="/Mojo::UserAgent::Proxy.html">Mojo::UserAgent::Proxy</a>オブジェクト。</p>

<pre># 環境からプロキシサーバーを検知します。
$ua-&gt;proxy-&gt;detect;

# 手動でHTTPプロキシを設定(HTTPS/WebSocketsのためにCONNECTを使う)
$ua-&gt;proxy-&gt;http('http://127.0.0.1:8080')-&gt;https('http://127.0.0.1:8080');

# Tor(SOCKS5)のための手動での設定
$ua-&gt;proxy-&gt;http('socks://127.0.0.1:9050')-&gt;https('socks://127.0.0.1:9050');

# 手動でUNIXドメインソケットを設定する(HTTPS/WebSocketsのためにCONNECTを使います)
$ua-&gt;proxy-&gt;http('http+unix://%2Ftmp%2Fproxy.sock')
  -&gt;https('http+unix://%2Ftmp%2Fproxy.sock');</pre>

<h4><a class='u'
name="request_timeout"
>request_timeout</a></h4>

<pre>my $timeout = $ua-&gt;request_timeout;
$ua         = $ua-&gt;request_timeout(5);</pre>

<p>「接続が確立、リクエストが送信、完全なレスポンスを受けとる」ことがキャンセルされるまでの 最大秒数。デフォルトは、<code>MOJO_REQUEST_TIMEOUT</code>環境変数の値か<code>0</code>。 この値を<code>0</code>に設定すると、ユーザーエージェントが無限に待つことを許可します。 タイムアウトはすべての続くリダイレクトにおいてリセットされます。</p>

<pre># 全体の制限は5秒、接続には3秒が費やされるかもしれない。
$ua-&gt;max_redirects(0)-&gt;connect_timeout(3)-&gt;request_timeout(5);</pre>

<h4><a class='u'
name="server"
>server</a></h4>

<pre>my $server = $ua-&gt;server;
$ua        = $ua-&gt;server(Mojo::UserAgent::Server-&gt;new);</pre>

<p>アプリケーションサーバーの相対URLが一緒に処理されます。 デフォルトは<a href="/Mojo::UserAgent::Server.html">Mojo::UserAgent::Server</a>です。</p>

<pre># Webサービスをモックする
$ua-&gt;server-&gt;app(Mojolicious-&gt;new);
$ua-&gt;server-&gt;app-&gt;routes-&gt;get('/time' =&gt; sub {
  my $c = shift;
  $c-&gt;render(json =&gt; {now =&gt; time});
});
my $time = $ua-&gt;get('/time')-&gt;result-&gt;json-&gt;{now};

# ログレベルの変更
$ua-&gt;server-&gt;app-&gt;log-&gt;level('fatal');

# 相対URLのブロッキングを処理するために現在利用されているポート
say $ua-&gt;server-&gt;url-&gt;port;

# 相対URLのノンブロッキングを処理するために現在利用されているポート
say $ua-&gt;server-&gt;nb_url-&gt;port;</pre>

<h4><a class='u'
name="transactor"
>transactor</a></h4>

<pre>my $t = $ua-&gt;transactor;
$ua   = $ua-&gt;transactor(Mojo::UserAgent::Transactor-&gt;new);</pre>

<p>トランザクションビルダー。 デフォルトは<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>オブジェクトです。</p>

<pre># ユーザーエージェントの名前を変更
$ua-&gt;transactor-&gt;name('MyUA 1.0');

# 圧縮を無効にする
$ua-&gt;transactor-&gt;compressed(0);</pre>

<h3><a class='u'
name="_"
>メソッド</a></h3>

<p><a href="/Mojo::UserAgent.html">Mojo::UserAgent</a> は <a href="/Mojo::EventEmitter.html">Mojo::EventEmitter</a> のすべてのメソッドを継承しており、 以下の新しいメソッドを実装しています。</p>

<h4><a class='u'
name="build_tx"
>build_tx</a></h4>

<pre>my $tx = $ua-&gt;build_tx(GET =&gt; 'example.com');
my $tx = $ua-&gt;build_tx(
  PUT =&gt; 'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Content!');
my $tx = $ua-&gt;build_tx(
  PUT =&gt; 'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;build_tx(
  PUT =&gt; 'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p><a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>メソッドで <a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクトを生成します。</p>

<pre># カスタムクッキーを持ったリクエスト
my $tx = $ua-&gt;build_tx(GET =&gt; 'https://example.com/account');
$tx-&gt;req-&gt;cookies({name =&gt; 'user', value =&gt; 'sri'});
$tx = $ua-&gt;start($tx);

# gzip圧縮を非アクティブにする
my $tx = $ua-&gt;build_tx(GET =&gt; 'example.com');
$tx-&gt;req-&gt;headers-&gt;remove('Accept-Encoding');
$tx = $ua-&gt;start($tx);

# ひとつのエラーを発生することによって、レスポンスを中断する
my $tx = $ua-&gt;build_tx(GET =&gt; 'example.com');
$tx-&gt;res-&gt;on(progress =&gt; sub {
  my $res = shift;
  return unless my $server = $res-&gt;headers-&gt;server;
  $res-&gt;error({message =&gt; 'Oh noes, it is IIS!'}) if $server =~ /IIS/;
});
$tx = $ua-&gt;start($tx);</pre>

<h4><a class='u'
name="build_websocket_tx"
>build_websocket_tx</a></h4>

<pre>my $tx = $ua-&gt;build_websocket_tx('ws://example.com');
my $tx = $ua-&gt;build_websocket_tx(
  'ws://example.com' =&gt; {DNT =&gt; 1} =&gt; ['v1.proto']);</pre>

<p><a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>websocket</code>メソッドで <a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクトを生成します。</p>

<pre># クッキーを持ったWebSocketハンドシェイク
my $tx = $ua-&gt;build_websocket_tx('wss://example.com/echo');
$tx-&gt;req-&gt;cookies({name =&gt; 'user', value =&gt; 'sri'});
$ua-&gt;start($tx =&gt; sub {
  my ($ua, $tx) = @_;
  say 'WebSocket handshake failed!' and return unless $tx-&gt;is_websocket;
  $tx-&gt;on(message =&gt; sub {
    my ($tx, $msg) = @_;
    say "WebSocket message: $msg";
    $tx-&gt;finish;
  });
  $tx-&gt;send('Hi!');
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="delete"
>delete</a></h4>

<pre>my $tx = $ua-&gt;delete('example.com');
my $tx = $ua-&gt;delete('http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Hi!');
my $tx = $ua-&gt;delete(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;delete(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p>ブロッキングする<code>DELETE</code>リクエストを実行し、結果である<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクト を返却します。 (メソッドを除いて)<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>とまったく同じ引数を受け取ります。 ノンブロッキングのリクエストを実行するため、コールバックを追加することも できます。</p>

<pre>$ua-&gt;delete('http://example.com' =&gt; json =&gt; {a =&gt; 'b'} =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="delete_p"
>delete_p</a></h4>

<pre>my $promise = $ua-&gt;delete_p('http://example.com');</pre>

<p>Same as <a href="#delete" class="podlinkpod"
>"delete"</a>, but performs all requests non-blocking and returns a <a href="https://metacpan.org/pod/Mojo%3A%3APromise" class="podlinkpod"
>Mojo::Promise</a> object instead of accepting a callback.</p>

<p>"delete"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;delete_p('http://example.com' =&gt; json =&gt; {a =&gt; 'b'})-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="get"
>get</a></h4>

<pre>my $tx = $ua-&gt;get('example.com');
my $tx = $ua-&gt;get('http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Hi!');
my $tx = $ua-&gt;get(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;get(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p>ブロッキングするHTTP <code>GET</code>リクエストを実行し、結果である<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクト を返却します。 (メソッドを除いて)<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>とまったく同じ引数を受け取ります。 ノンブロッキングのリクエストを実行するため、コールバックを追加することも できます。</p>

<pre>$ua-&gt;get('http://example.com' =&gt; json =&gt; {a =&gt; 'b'} =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="get_p"
>get_p</a></h4>

<pre>my $promise = $ua-&gt;get_p('http://example.com');</pre>

<p>"get"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;get_p('http://example.com' =&gt; json =&gt; {a =&gt; 'b'})-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="head"
>head</a></h4>

<pre>my $tx = $ua-&gt;head('example.com');
my $tx = $ua-&gt;head('http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Hi!');
my $tx = $ua-&gt;head(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;head(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p>ブロッキングするHTTP <code>HEAD</code>リクエストを実行し、結果である<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクト を返却します。 (メソッドを除いて)<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>とまったく同じ引数を受け取ります。 ノンブロッキングのリクエストを実行するため、コールバックを追加することも できます。</p>

<pre>$ua-&gt;head('http://example.com' =&gt; json =&gt; {a =&gt; 'b'} =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="head_p"
>head_p</a></h4>

<pre>my $promise = $ua-&gt;head_p('http://example.com');</pre>

<p>"head"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;head_p('http://example.com' =&gt; json =&gt; {a =&gt; 'b'})-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="options"
>options</a></h4>

<pre>my $tx = $ua-&gt;options('example.com');
my $tx = $ua-&gt;options('http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Hi!');
my $tx = $ua-&gt;options(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;options(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p>ブロッキングする<code>OPTIONS</code>リクエストを実行し、結果である<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクト を返却します。 (メソッドを除いて)<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>とまったく同じ引数を受け取ります。 ノンブロッキングのリクエストを実行するため、コールバックを追加することも できます。</p>

<pre>$ua-&gt;options('http://example.com' =&gt; json =&gt; {a =&gt; 'b'} =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="options_p"
>options_p</a></h4>

<pre>my $promise = $ua-&gt;options_p('http://example.com');</pre>

<p>"options"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;options_p('http://example.com' =&gt; json =&gt; {a =&gt; 'b'})-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="patch"
>patch</a></h4>

<pre>my $tx = $ua-&gt;patch('example.com');
my $tx = $ua-&gt;patch('http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Hi!');
my $tx = $ua-&gt;patch(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;patch(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p>ブロッキングする<code>PATCH</code>リクエストを実行し、結果である<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクト を返却します。 (メソッドを除いて)<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>とまったく同じ引数を受け取ります。 ノンブロッキングのリクエストを実行するため、コールバックを追加することも できます。</p>

<pre>$ua-&gt;patch('http://example.com' =&gt; json =&gt; {a =&gt; 'b'} =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="patch_p"
>patch_p</a></h4>

<pre>my $promise = $ua-&gt;patch_p('http://example.com');</pre>

<p>"patch"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;patch_p('http://example.com' =&gt; json =&gt; {a =&gt; 'b'})-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="post"
>post</a></h4>

<pre>my $tx = $ua-&gt;post('example.com');
my $tx = $ua-&gt;post('http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Hi!');
my $tx = $ua-&gt;post(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;post(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p>ブロッキングする<code>POST</code>リクエストを実行し、結果である<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクト を返却します。 (メソッドを除いて)<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>とまったく同じ引数を受け取ります。 ノンブロッキングのリクエストを実行するため、コールバックを追加することも できます。</p>

<pre>$ua-&gt;post('http://example.com' =&gt; json =&gt; {a =&gt; 'b'} =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="post_p"
>post_p</a></h4>

<pre>my $promise = $ua-&gt;post_p('http://example.com');</pre>

<p>"post"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;post_p('http://example.com' =&gt; json =&gt; {a =&gt; 'b'})-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="put"
>put</a></h4>

<pre> my $tx = $ua-&gt;put('example.com');
my $tx = $ua-&gt;put('http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; 'Hi!');
my $tx = $ua-&gt;put(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; form =&gt; {a =&gt; 'b'});
my $tx = $ua-&gt;put(
  'http://example.com' =&gt; {Accept =&gt; '*/*'} =&gt; json =&gt; {a =&gt; 'b'});</pre>

<p>ブロッキングする<code>PUT</code>リクエストを実行し、結果である<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクト を返却します。 (メソッドを除いて)<a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>tx</code>とまったく同じ引数を受け取ります。 ノンブロッキングのリクエストを実行するため、コールバックを追加することも できます。</p>

<pre>$ua-&gt;put('http://example.com' =&gt; json =&gt; {a =&gt; 'b'} =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="put_p"
>put_p</a></h4>

<pre>my $promise = $ua-&gt;put_p('http://example.com');</pre>

<p>"put"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;put_p('http://example.com' =&gt; json =&gt; {a =&gt; 'b'})-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="start"
>start</a></h4>

<pre>my $tx = $ua-&gt;start(Mojo::Transaction::HTTP-&gt;new);</pre>

<p>カスタムの<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクトのためにブロッキングするリクエストを処理します。 ノンブロッキングのトランザクションを実行するため、コールバックを追加することも できます。</p>

<pre>my $tx = $ua-&gt;build_tx(GET =&gt; 'http://example.com');
$ua-&gt;start($tx =&gt; sub {
  my ($ua, $tx) = @_;
  say $tx-&gt;result-&gt;body;
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<h4><a class='u'
name="start_p"
>start_p</a></h4>

<pre>my $promise = $ua-&gt;start_p(Mojo::Transaction::HTTP-&gt;new);</pre>

<p>"start"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>my $tx = $ua-&gt;build_tx(GET =&gt; 'http://example.com');
$ua-&gt;start_p($tx)-&gt;then(sub {
  my $tx = shift;
  say $tx-&gt;result-&gt;body;
})-&gt;catch(sub {
  my $err = shift;
  warn "Connection error: $err";
})-&gt;wait;</pre>

<h4><a class='u'
name="websocket"
>websocket</a></h4>

<pre>$ua-&gt;websocket('ws://example.com' =&gt; sub {...});
$ua-&gt;websocket(
  'ws://example.com' =&gt; {DNT =&gt; 1} =&gt; ['v1.proto'] =&gt; sub {...});</pre>

<p>透過的なハンドシェイクでノンブロッキングのWebSocket接続をオープンします。 <a href="/Mojo::UserAgent::Transactor.html">Mojo::UserAgent::Transactor</a>の<code>websocket</code>とまったく同じ引数を受け取ります。 コールバックは、ハンドシェイクが成功しかたに依存して、<a href="/Mojo::Transaction::WebSocket.html">Mojo::Transaction::WebSocket</a>オブジェクトか<a href="/Mojo::Transaction::HTTP.html">Mojo::Transaction::HTTP</a>オブジェクトを受け取ります。</p>

<pre>$ua-&gt;websocket('wss://example.com/echo' =&gt; ['v1.proto'] =&gt; sub {
  my ($ua, $tx) = @_;
  say 'WebSocket handshake failed!' and return unless $tx-&gt;is_websocket;
  say 'Subprotocol negotiation failed!' and return unless $tx-&gt;protocol;
  $tx-&gt;on(finish =&gt; sub {
    my ($tx, $code, $reason) = @_;
    say "WebSocket closed with status $code.";
  });
  $tx-&gt;on(message =&gt; sub {
    my ($tx, $msg) = @_;
    say "WebSocket message: $msg";
    $tx-&gt;finish;
  });
  $tx-&gt;send('Hi!');
});
Mojo::IOLoop-&gt;start unless Mojo::IOLoop-&gt;is_running;</pre>

<p><code>Sec-WebSocket-Extensions</code>を設定することによって、 <code>permessage-deflate</code>圧縮をアクティブにすることができます。 これはよりよりパフォーマンスをもたらすでしょう。 しかし、コネクションあたりメモリ使用率は300KB上昇します。</p>

<pre>$ua-&gt;websocket('ws://example.com/foo' =&gt; {
  'Sec-WebSocket-Extensions' =&gt; 'permessage-deflate'
} =&gt; sub {...});</pre>

<h4><a class='u'
name="websocket_p"
>websocket_p</a></h4>

<pre>my $promise = $ua-&gt;websocket_p('ws://example.com');</pre>

<p>"websocket"と同じですが、すべてのリクエストをノンブロッキングで実行し、 コールバックを受け付ける代わりに、<a href="/Mojo::Promise.html">Mojo::Promise</a>オブジェクトを返します。</p>

<pre>$ua-&gt;websocket_p('wss://example.com/echo')-&gt;then(sub {
  my $tx = shift;
  my $promise = Mojo::Promise-&gt;new;
  $tx-&gt;on(finish =&gt; sub { $promise-&gt;resolve });
  $tx-&gt;on(message =&gt; sub {
    my ($tx, $msg) = @_;
    say "WebSocket message: $msg";
    $tx-&gt;finish;
  });
  $tx-&gt;send('Hi!');
  return $promise;
})-&gt;catch(sub {
  my $err = shift;
  warn "WebSocket error: $err";
})-&gt;wait;</pre>

<h3><a class='u'
name="_"
>デバッグ</a></h3>

<p>いくらかの発展的な詳細な情報を<code>STDERR</code>に出力するために、 <code>MOJO_USERAGENT_DEBUG</code>環境変数を設定することができます。</p>

<pre>MOJO_USERAGENT_DEBUG=1</pre>

<h3><a class='u'
name="_"
>参考</a></h3>

<p><a href="/Mojolicious.html">Mojolicious</a>, <a href="/Mojolicious::Guides.html">Mojolicious::Guides</a>, <a href="http://mojolicio.us" class="podlinkurl"
>http://mojolicio.us</a>.</p>

<p>(Mojolicious 8.12を反映。2019年5月30日更新)</p>

<!-- end doc -->

</body></html>

  </div>
  <div class="bottom">
    <div class="perlclub_register">
  <a rel="nofollow" href="https://perlclub.net/account/create">Perlクラブへの<br>無料の会員登録で<br>書籍サンプルプレゼント</a>
</div>

  </div>
</div>

        </div>
        <div class="side">
          <div class="side_list">
  <div class="side_list_title">
    Perlテキスト処理のエッセンス
  </div>
  <div class="side_list_body">
    <ul>
      <li>
        <div class="side_list_image">
          <a rel="nofollow" href="https://www.amazon.co.jp/gp/product/B097T6CBR6/ref=as_li_tl?ie=UTF8&tag=perlgenki-22&camp=247&creative=1211&linkCode=as2&creativeASIN=B097T6CBR6&linkId=e9078757396f4ceb239e325242bb830a"><img src="https://perlclub.net/images/book/perl_text_essence/perl_text_essence.jpg"></a>
        </div>
        <div class="side_list_description">
          <div >初級者向け・テキスト処理と正規表現の基本をマスター</div>
        </div>
      </li>
    </ul>
  </div>
</div>

<div class="side_list">
  <div class="side_list_title">
    業務に役立つPerl
  </div>
  <div class="side_list_body">
    <ul>
      <li>
        <div class="side_list_image">
          <a  rel="nofollow" href="https://www.amazon.co.jp/gp/product/4774150258/ref=as_li_tl?ie=UTF8&tag=perlgenki-22&camp=247&creative=1211&linkCode=as2&creativeASIN=4774150258&linkId=45a02b2a4b32fce3dcee590267c7cd9a"><img src="https://perlclub.net/images/book/perl_gyoumu/perl_gyoumu.jpg"></a>
        </div>
        <div class="side_list_description">
          実務者向け・ログ解析など日本語を含むテキスト処理の実践!
        </div>
      </li>
    </ul>
  </div>
</div>

<div class="side_list">
  <div class="side_list_title">
    Perlクラブ
  </div>
  <div class="side_list_body">
    <ul>
      <li>
        <div class="side_list_image">
          <a rel="nofollow" href="https://perlclub.net/"><img style="width:130px" src="https://perlclub.net/images/perl_club_logo.png"></a>
        </div>
        <div class="side_list_description">
          仲間と出会い<br>ゆとりあるエンジニアライフを送る
        </div>
      </li>
    </ul>
  </div>
</div>

        </div>
      </div>
      <div class="footer">
        <div class="perlri_link">
  <a rel="nofollow" href="https://perlclub.net">Perlクラブ</a>
</div>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4525414114581084"
     crossorigin="anonymous"></script>
     
      </div>
    </div>
  </body>
</html>
